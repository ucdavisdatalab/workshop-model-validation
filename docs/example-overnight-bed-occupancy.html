<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Example: Overnight bed occupancy | Model validation for applied data science</title>
  <meta name="description" content="5 Example: Overnight bed occupancy | Model validation for applied data science" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Example: Overnight bed occupancy | Model validation for applied data science" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ucdavisdatalab.github.io/workshop_model_validation/" />
  
  
  <meta name="github-repo" content="ucdavisdatalab/workshop_model_validation" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Example: Overnight bed occupancy | Model validation for applied data science" />
  
  
  

<meta name="author" content="Wesley Brooks" />


<meta name="date" content="2021-11-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-splitting-systems.html"/>
<link rel="next" href="example-covid-19-admissions.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://datalab.ucdavis.edu/">
  <img src="https://datalab.ucdavis.edu/wp-content/uploads/2019/07/datalab-logo-full-color-rgb-1.png" style="height: 100%; width: 100%; object-fit: contain" />
</a></li>
<li><a href="./" style="font-size: 18px">Model validation for applied data science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#learning-goals"><i class="fa fa-check"></i><b>0.1</b> Learning goals</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i><b>0.2</b> Prerequisites</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#software"><i class="fa fa-check"></i><b>0.3</b> Software</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="beginnings.html"><a href="beginnings.html"><i class="fa fa-check"></i><b>1</b> Beginnings</a>
<ul>
<li class="chapter" data-level="1.1" data-path="beginnings.html"><a href="beginnings.html#why-model-validation"><i class="fa fa-check"></i><b>1.1</b> Why model validation?</a></li>
<li class="chapter" data-level="1.2" data-path="beginnings.html"><a href="beginnings.html#what-is-model-validation"><i class="fa fa-check"></i><b>1.2</b> What is model validation?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="example-data-covid-19-counts.html"><a href="example-data-covid-19-counts.html"><i class="fa fa-check"></i><b>2</b> Example data: COVID-19 counts</a></li>
<li class="chapter" data-level="3" data-path="model-types.html"><a href="model-types.html"><i class="fa fa-check"></i><b>3</b> Model types</a>
<ul>
<li class="chapter" data-level="3.1" data-path="model-types.html"><a href="model-types.html#linear-regression"><i class="fa fa-check"></i><b>3.1</b> Linear regression</a></li>
<li class="chapter" data-level="3.2" data-path="model-types.html"><a href="model-types.html#boosted-forest-model"><i class="fa fa-check"></i><b>3.2</b> Boosted forest model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-splitting-systems.html"><a href="data-splitting-systems.html"><i class="fa fa-check"></i><b>4</b> Data splitting systems</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-splitting-systems.html"><a href="data-splitting-systems.html#trainvalidation-split"><i class="fa fa-check"></i><b>4.1</b> Train/validation split</a></li>
<li class="chapter" data-level="4.2" data-path="data-splitting-systems.html"><a href="data-splitting-systems.html#cross-validation"><i class="fa fa-check"></i><b>4.2</b> Cross-validation</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="data-splitting-systems.html"><a href="data-splitting-systems.html#time-series-data"><i class="fa fa-check"></i><b>4.2.1</b> Time series data</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="data-splitting-systems.html"><a href="data-splitting-systems.html#combiniations"><i class="fa fa-check"></i><b>4.3</b> Combiniations</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html"><i class="fa fa-check"></i><b>5</b> Example: Overnight bed occupancy</a>
<ul>
<li class="chapter" data-level="5.1" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#checking-whether-observations-are-independent"><i class="fa fa-check"></i><b>5.1</b> Checking whether observations are independent</a></li>
<li class="chapter" data-level="5.2" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#validating-the-distribution-for-a-linear-model"><i class="fa fa-check"></i><b>5.2</b> Validating the distribution for a linear model</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#examiune-diagnostic-plots"><i class="fa fa-check"></i><b>5.2.1</b> Examiune diagnostic plots</a></li>
<li class="chapter" data-level="5.2.2" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#what-to-do-about-the-diagnostic-plots"><i class="fa fa-check"></i><b>5.2.2</b> What to do about the diagnostic plots</a></li>
<li class="chapter" data-level="5.2.3" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#try-a-log-transform"><i class="fa fa-check"></i><b>5.2.3</b> Try a log transform</a></li>
<li class="chapter" data-level="5.2.4" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#try-square-root-transform"><i class="fa fa-check"></i><b>5.2.4</b> Try square root transform</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#filter-candidates-by-cross-validation"><i class="fa fa-check"></i><b>5.3</b> Filter candidates by cross-validation</a></li>
<li class="chapter" data-level="5.4" data-path="example-overnight-bed-occupancy.html"><a href="example-overnight-bed-occupancy.html#final-validation-selection"><i class="fa fa-check"></i><b>5.4</b> Final validation / selection</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="example-covid-19-admissions.html"><a href="example-covid-19-admissions.html"><i class="fa fa-check"></i><b>6</b> Example: COVID-19 admissions</a>
<ul>
<li class="chapter" data-level="6.1" data-path="example-covid-19-admissions.html"><a href="example-covid-19-admissions.html#checking-whether-observations-are-independent-1"><i class="fa fa-check"></i><b>6.1</b> Checking whether observations are independent</a></li>
<li class="chapter" data-level="6.2" data-path="example-covid-19-admissions.html"><a href="example-covid-19-admissions.html#distribution-of-the-response"><i class="fa fa-check"></i><b>6.2</b> Distribution of the response</a></li>
<li class="chapter" data-level="6.3" data-path="example-covid-19-admissions.html"><a href="example-covid-19-admissions.html#boosted-forest-model-1"><i class="fa fa-check"></i><b>6.3</b> Boosted forest model</a></li>
<li class="chapter" data-level="6.4" data-path="example-covid-19-admissions.html"><a href="example-covid-19-admissions.html#validating-the-model"><i class="fa fa-check"></i><b>6.4</b> Validating the model</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Model validation for applied data science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="example-overnight-bed-occupancy" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Example: Overnight bed occupancy</h1>
<p>Recall that one of our goals is to predict the number of hospital beds that will be occupied tonight by COVID-19 patients. Before beginning, let’s split the data in half - we’ll use the first half for model building and intermediate validation, and reserve the second half for final validation.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="example-overnight-bed-occupancy.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add a variable to covid for the one-day-ahead census (the prediction target)</span></span>
<span id="cb4-2"><a href="example-overnight-bed-occupancy.html#cb4-2" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>D1_census <span class="ot">=</span> <span class="fu">lead</span>( covid<span class="sc">$</span>COVID_PT_CNT_M, <span class="dv">1</span> )</span>
<span id="cb4-3"><a href="example-overnight-bed-occupancy.html#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="example-overnight-bed-occupancy.html#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create a 50/50 train/validation split of the covid data</span></span>
<span id="cb4-5"><a href="example-overnight-bed-occupancy.html#cb4-5" aria-hidden="true" tabindex="-1"></a>covid_split <span class="ot">=</span> <span class="fu">validation_time_split</span>( covid, <span class="at">prop=</span><span class="fl">0.5</span> )</span>
<span id="cb4-6"><a href="example-overnight-bed-occupancy.html#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="example-overnight-bed-occupancy.html#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the covid_train data set</span></span>
<span id="cb4-8"><a href="example-overnight-bed-occupancy.html#cb4-8" aria-hidden="true" tabindex="-1"></a>covid_train <span class="ot">=</span> <span class="fu">training</span>( covid_split<span class="sc">$</span>splits[[<span class="dv">1</span>]] )</span></code></pre></div>
<div id="checking-whether-observations-are-independent" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Checking whether observations are independent</h2>
<p>That’s count data, but we may suspect that the nightly counts are not independent, because it is common for a person to spend consecutive nights in the hospital. Let’s check the autocorrelation of the counts to see if our hunch is correct.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="example-overnight-bed-occupancy.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>( <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>) )</span>
<span id="cb5-2"><a href="example-overnight-bed-occupancy.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>( covid_train, <span class="fu">plot</span>( date, COVID_PT_CNT_M, <span class="at">type=</span><span class="st">&#39;l&#39;</span>) )</span>
<span id="cb5-3"><a href="example-overnight-bed-occupancy.html#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>( covid_train<span class="sc">$</span>COVID_PT_CNT_M )</span></code></pre></div>
<p><img src="04_census-example_files/figure-html/census-acf-1.png" width="672" /></p>
<p>The plot on the left is the time series of overnight census counts, and the plot on the right is the autocorrelation function. The gist of the autocorrelation function is that the “Lag” indicates a number of days separating data points, and when the lines are far above or below zero then there is correlation between points that are separated by that many days. The correlation at lag zero is always one because that is comparing a day’s data to itself (separated by zero days).</p>
<p>There is a lot of autocorrelation in this time series. This may be ok if we can “control for” the correlation. It is possible to control for autocorrelation if the long-term correlation between distant observations is the same as the relationship between neighboring observations, iterated for every data point that separates the two distant observations. In that case, the data are independent, conditional on the previous day’s count. In practice that means including the previous day’s count as a predictor in the model.</p>
<p>The way to think about The smoothly decaying autocorrelation as the lag time increases tells us that the nightly counts are correlated with the previous count in a consistent pattern. In that case, the increments may be independent, even though the individual observations are not.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="example-overnight-bed-occupancy.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>( <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>) )</span>
<span id="cb6-2"><a href="example-overnight-bed-occupancy.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>( covid_train, <span class="fu">plot</span>( date, <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(COVID_PT_CNT_M, <span class="dv">1</span> )), <span class="at">type=</span><span class="st">&#39;l&#39;</span>))</span>
<span id="cb6-3"><a href="example-overnight-bed-occupancy.html#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>( <span class="fu">diff</span>(covid_train<span class="sc">$</span>COVID_PT_CNT_M, <span class="dv">1</span>) )</span></code></pre></div>
<p><img src="04_census-example_files/figure-html/census-diff-acf-1.png" width="672" /></p>
<p>Now the autocorrelation looks much better because most of the vertical lines are very small (the first line will always touch a maximum value of 1 by definition). This is an indication that a linear model for the nightly bed occupancy should use the previous night’s occupancy as a predictor.</p>
</div>
<div id="validating-the-distribution-for-a-linear-model" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Validating the distribution for a linear model</h2>
<p>A linear model (like what you get from R’s <code>lm()</code> function) comes with some assumptions, and helpfully provides simple tools to help you validate them. Among these are assumptions that the errors have a normal distribution with constant variance. Let’s look at how to test that.</p>
<div id="examiune-diagnostic-plots" class="section level3" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Examiune diagnostic plots</h3>
<p>Validating the assumptions about the distribution of errors in a linear model is usually done through the diagnostic plots. These are four plots you get when you <code>plot()</code> a fitted <code>lm()</code> model. We already know that our example will use the previous night’s occupancy as a predictor, so let’s start with the simplest model of that kind.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="example-overnight-bed-occupancy.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the AR1 model</span></span>
<span id="cb7-2"><a href="example-overnight-bed-occupancy.html#cb7-2" aria-hidden="true" tabindex="-1"></a>census_model <span class="ot">=</span> <span class="fu">lm</span>( D1_census <span class="sc">~</span> COVID_PT_CNT_M, <span class="at">data=</span>covid_train )</span>
<span id="cb7-3"><a href="example-overnight-bed-occupancy.html#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="example-overnight-bed-occupancy.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show the diagnostic plots in a 2x2 layout</span></span>
<span id="cb7-5"><a href="example-overnight-bed-occupancy.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>( <span class="fu">matrix</span>( <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span> ) )</span>
<span id="cb7-6"><a href="example-overnight-bed-occupancy.html#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb7-7"><a href="example-overnight-bed-occupancy.html#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( census_model )</span></code></pre></div>
<p><img src="04_census-example_files/figure-html/census-ar-model-1.png" width="672" /></p>
<p>These plots reveal some classic problems with the linear model <code>census_model</code>. Learn to recognize these, and you’re well on your way to doing good data analysis. We will look at the first three, since the fourth plot is less often relevant, and requires a deeper understanding of the model’s structure.</p>
<div id="residual-vs.-fitted" class="section level4" number="5.2.1.1">
<h4><span class="header-section-number">5.2.1.1</span> Residual vs. fitted</h4>
<p>The ideal is for the points in this plot to exhibit no pattern. But the points in this plot are arrayed in a fan shape that widens to the right. This suggests that the residuals get more variable as the fitted value increases. The other common problem that could be seen in the residual vs. fitted plot is a “U” shape (or upside-down “U”), which would suggest that the relationship between the predictors and the response is not linear. We don’t have any kind of “U” shape here, though.</p>
</div>
<div id="scale-location" class="section level4" number="5.2.1.2">
<h4><span class="header-section-number">5.2.1.2</span> Scale-location</h4>
<p>The ideal for this plot is also to have no apparent pattern. But in this example, we can see that the points are more tightly clustered on the left, and more spread out on the right. As in the Residual vs. Fitted plot, this is an indication that the residuals are not constant for different fitted values. The red line is a smoothing line that helps clarify the pattern in the dots.</p>
</div>
<div id="normal-q-q" class="section level4" number="5.2.1.3">
<h4><span class="header-section-number">5.2.1.3</span> Normal Q-Q</h4>
<p>This plot helps you to validate the assumption that the residuals are from a normal distribution with constant variance. The ideal for this plot is to have all of the dots lie on the dotted line. That’s not the case here, as the dots at both ends bend away from the dotted line. This is an indication of “heavy tails”, which may be because the residuals are more variable as the fitted values increase.</p>
</div>
</div>
<div id="what-to-do-about-the-diagnostic-plots" class="section level3" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> What to do about the diagnostic plots</h3>
<p>The patterns seen here suggest that it may be appropriate to transform the response variable in a way that compresses the larger values, relative to the smaller values. The most commonly used transformations of this kind are a logarithm or a square root transformation. There is no “U” shape in the residual vs. fitted plot, so we see no problem with the assumption that the response is a linear function of the predictors. Therefore, in order to not spoil the linear relationship, we should apply the same transformation to the predictor as to the response.</p>
</div>
<div id="try-a-log-transform" class="section level3" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Try a log transform</h3>
<p>Here’s the code to fit a model with the log transform and generate the diagnostic plots.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="example-overnight-bed-occupancy.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the log model</span></span>
<span id="cb8-2"><a href="example-overnight-bed-occupancy.html#cb8-2" aria-hidden="true" tabindex="-1"></a>census_model_log <span class="ot">=</span> <span class="fu">lm</span>( <span class="fu">log</span>(D1_census) <span class="sc">~</span> <span class="fu">log</span>(COVID_PT_CNT_M), <span class="at">data=</span>covid_train )</span>
<span id="cb8-3"><a href="example-overnight-bed-occupancy.html#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="example-overnight-bed-occupancy.html#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show the diagnostic plots in a 2x2 layout</span></span>
<span id="cb8-5"><a href="example-overnight-bed-occupancy.html#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>( <span class="fu">matrix</span>( <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span> ) )</span>
<span id="cb8-6"><a href="example-overnight-bed-occupancy.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb8-7"><a href="example-overnight-bed-occupancy.html#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( census_model_log )</span></code></pre></div>
<p><img src="04_census-example_files/figure-html/census-log-ar-model-1.png" width="672" /></p>
<p>The patterns in the Residual vs. Fitted and Scale-Location plots are the opposite of what they were for the untransformed model (the fan opens to the left, and the scale gets smaller for greater fitted values). Once again, it looks like the assumption of normal residuals with constant variance isn’t supported.</p>
</div>
<div id="try-square-root-transform" class="section level3" number="5.2.4">
<h3><span class="header-section-number">5.2.4</span> Try square root transform</h3>
<p>The log transform went too far in compressing the greater counts relative to the smaller counts. The square root transforms data in a similar way, qualitatively, but is less extreme. Let’s see what happens when we use that transform instead.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="example-overnight-bed-occupancy.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the square-root model</span></span>
<span id="cb9-2"><a href="example-overnight-bed-occupancy.html#cb9-2" aria-hidden="true" tabindex="-1"></a>census_model_sqrt <span class="ot">=</span> <span class="fu">lm</span>( <span class="fu">sqrt</span>(D1_census) <span class="sc">~</span> <span class="fu">sqrt</span>(COVID_PT_CNT_M), <span class="at">data=</span>covid_train )</span>
<span id="cb9-3"><a href="example-overnight-bed-occupancy.html#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="example-overnight-bed-occupancy.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show the diagnostic plots in a 2x2 layout</span></span>
<span id="cb9-5"><a href="example-overnight-bed-occupancy.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>( <span class="fu">matrix</span>( <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span> ) )</span>
<span id="cb9-6"><a href="example-overnight-bed-occupancy.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb9-7"><a href="example-overnight-bed-occupancy.html#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( census_model_sqrt )</span></code></pre></div>
<p><img src="04_census-example_files/figure-html/census-sqrt-ar-model-1.png" width="672" /></p>
<p>Now, these diagnostic plots are not exactly perfect, but they are about as close as you can get with real-world data. Under the square root transformation, we have validated the assumption that the model residuals are normally distributed with constant variance.</p>
</div>
</div>
<div id="filter-candidates-by-cross-validation" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Filter candidates by cross-validation</h2>
<p>The final step in this example is to demonstrate selecting the variables for the linear regression model. Since the model will be used in prediction, we want to pick the set of predictors that generate the best performance on out-of-sample data. To do so, we need to test the candidates on out-of-sample data, and pick the one that performs best. We have reserved some out-of sample data, but that is for final validation. While we sort through candidate models, let us continue to use the training data. We will use cross-validation to simulate how it does over new data. Once we have a few candidate models in mind, we will use the validation data to pick one of them.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="example-overnight-bed-occupancy.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set a random seed for the sake of reproducibility</span></span>
<span id="cb10-2"><a href="example-overnight-bed-occupancy.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20211119</span>)</span>
<span id="cb10-3"><a href="example-overnight-bed-occupancy.html#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="example-overnight-bed-occupancy.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of five candidate models</span></span>
<span id="cb10-5"><a href="example-overnight-bed-occupancy.html#cb10-5" aria-hidden="true" tabindex="-1"></a>formulas <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb10-6"><a href="example-overnight-bed-occupancy.html#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">m1 =</span> <span class="fu">sqrt</span>(D1_census) <span class="sc">~</span> <span class="fu">sqrt</span>(COVID_PT_CNT_M),</span>
<span id="cb10-7"><a href="example-overnight-bed-occupancy.html#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">m2 =</span> <span class="fu">sqrt</span>(D1_census) <span class="sc">~</span> <span class="fu">sqrt</span>(COVID_PT_CNT_M) <span class="sc">+</span> COVID_NEW_ADM_MEAN,</span>
<span id="cb10-8"><a href="example-overnight-bed-occupancy.html#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">m3 =</span> <span class="fu">sqrt</span>(D1_census) <span class="sc">~</span> <span class="fu">sqrt</span>(COVID_PT_CNT_M) <span class="sc">+</span> COVID_NEW_ADM_MEAN <span class="sc">+</span> POSITIVITY_RATE_MEAN,</span>
<span id="cb10-9"><a href="example-overnight-bed-occupancy.html#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">m4 =</span> <span class="fu">sqrt</span>(D1_census) <span class="sc">~</span> <span class="fu">sqrt</span>(COVID_PT_CNT_M) <span class="sc">+</span> COVID_NEW_ADM_MEAN <span class="sc">+</span> POSITIVITY_RATE_MEAN <span class="sc">+</span> COVID_DISCHARGE_MEAN,</span>
<span id="cb10-10"><a href="example-overnight-bed-occupancy.html#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">m5 =</span> <span class="fu">sqrt</span>(D1_census) <span class="sc">~</span> <span class="fu">sqrt</span>(COVID_PT_CNT_M) <span class="sc">+</span> COVID_NEW_ADM_MEAN <span class="sc">+</span> POSITIVITY_RATE_MEAN <span class="sc">+</span> COVID_DISCHARGE_MEAN <span class="sc">+</span> COVID_PT_CNT_MIDNIGHT_MEAN</span>
<span id="cb10-11"><a href="example-overnight-bed-occupancy.html#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-12"><a href="example-overnight-bed-occupancy.html#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="example-overnight-bed-occupancy.html#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># create ten cross-validation folds</span></span>
<span id="cb10-14"><a href="example-overnight-bed-occupancy.html#cb10-14" aria-hidden="true" tabindex="-1"></a>covid_cv <span class="ot">=</span> <span class="fu">vfold_cv</span>( covid_train, <span class="at">v=</span><span class="dv">10</span> )</span>
<span id="cb10-15"><a href="example-overnight-bed-occupancy.html#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="example-overnight-bed-occupancy.html#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># create a workflow set of candidate models</span></span>
<span id="cb10-17"><a href="example-overnight-bed-occupancy.html#cb10-17" aria-hidden="true" tabindex="-1"></a>candidates <span class="ot">=</span> <span class="fu">workflow_set</span>(<span class="at">preproc =</span> formulas, <span class="at">models =</span> <span class="fu">list</span>(<span class="at">lm =</span> <span class="fu">linear_reg</span>()))</span>
<span id="cb10-18"><a href="example-overnight-bed-occupancy.html#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="example-overnight-bed-occupancy.html#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co"># run the candidates on the CV folds</span></span>
<span id="cb10-20"><a href="example-overnight-bed-occupancy.html#cb10-20" aria-hidden="true" tabindex="-1"></a>cv_result <span class="ot">=</span> <span class="fu">workflow_map</span>( candidates, <span class="st">&quot;fit_resamples&quot;</span>, <span class="at">resamples =</span> covid_cv) </span>
<span id="cb10-21"><a href="example-overnight-bed-occupancy.html#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="example-overnight-bed-occupancy.html#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># view the ranked results</span></span>
<span id="cb10-23"><a href="example-overnight-bed-occupancy.html#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="fu">rank_results</span>( cv_result, <span class="at">rank_metric=</span><span class="st">&quot;rmse&quot;</span> ) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&#39;rmse&#39;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 5 × 9
##   wflow_id .config        .metric  mean std_err     n preprocessor model    rank
##   &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;        &lt;chr&gt;   &lt;int&gt;
## 1 m5_lm    Preprocessor1… rmse    0.197 0.00919    10 formula      linear…     1
## 2 m3_lm    Preprocessor1… rmse    0.197 0.00963    10 formula      linear…     2
## 3 m4_lm    Preprocessor1… rmse    0.198 0.00995    10 formula      linear…     3
## 4 m2_lm    Preprocessor1… rmse    0.203 0.0103     10 formula      linear…     4
## 5 m1_lm    Preprocessor1… rmse    0.206 0.00971    10 formula      linear…     5</code></pre>
</div>
<div id="final-validation-selection" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> Final validation / selection</h2>
<p>Based on the exploratory modeling work, we conclude that models 5, 3, and 4 are the best candidates. Then we’ll send these three to the final validation stage, where we select the one that has the best accuracy over the validation data that was held out from the exploratory and modeling work.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="example-overnight-bed-occupancy.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># validation candidates are models 5, 4, and 3</span></span>
<span id="cb12-2"><a href="example-overnight-bed-occupancy.html#cb12-2" aria-hidden="true" tabindex="-1"></a>valcan <span class="ot">=</span> candidates[<span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">4</span>), ]</span>
<span id="cb12-3"><a href="example-overnight-bed-occupancy.html#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="example-overnight-bed-occupancy.html#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># run the validation candidates models on the validation data</span></span>
<span id="cb12-5"><a href="example-overnight-bed-occupancy.html#cb12-5" aria-hidden="true" tabindex="-1"></a>val_result <span class="ot">=</span> <span class="fu">workflow_map</span>( valcan, <span class="st">&quot;fit_resamples&quot;</span>, <span class="at">resamples =</span> covid_split) </span>
<span id="cb12-6"><a href="example-overnight-bed-occupancy.html#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="example-overnight-bed-occupancy.html#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># view the ranked results</span></span>
<span id="cb12-8"><a href="example-overnight-bed-occupancy.html#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rank_results</span>( val_result, <span class="at">rank_metric=</span><span class="st">&quot;rmse&quot;</span> ) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&#39;rmse&#39;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 9
##   wflow_id .config        .metric  mean std_err     n preprocessor model    rank
##   &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;        &lt;chr&gt;   &lt;int&gt;
## 1 m3_lm    Preprocessor1… rmse    0.215      NA     1 formula      linear…     1
## 2 m4_lm    Preprocessor1… rmse    0.216      NA     1 formula      linear…     2
## 3 m5_lm    Preprocessor1… rmse    0.217      NA     1 formula      linear…     3</code></pre>
<p>So we would select model three as the one that performs best in prediction. Here’s how it looks in prediction:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="example-overnight-bed-occupancy.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the test data</span></span>
<span id="cb14-2"><a href="example-overnight-bed-occupancy.html#cb14-2" aria-hidden="true" tabindex="-1"></a>covid_test <span class="ot">=</span> <span class="fu">testing</span>( covid_split<span class="sc">$</span>splits[[<span class="dv">1</span>]] )</span>
<span id="cb14-3"><a href="example-overnight-bed-occupancy.html#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="example-overnight-bed-occupancy.html#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create the final model</span></span>
<span id="cb14-5"><a href="example-overnight-bed-occupancy.html#cb14-5" aria-hidden="true" tabindex="-1"></a>census_model <span class="ot">=</span> <span class="fu">lm</span>( <span class="fu">sqrt</span>(D1_census) <span class="sc">~</span> <span class="fu">sqrt</span>(COVID_PT_CNT_M) <span class="sc">+</span></span>
<span id="cb14-6"><a href="example-overnight-bed-occupancy.html#cb14-6" aria-hidden="true" tabindex="-1"></a>                     COVID_NEW_ADM_MEAN <span class="sc">+</span></span>
<span id="cb14-7"><a href="example-overnight-bed-occupancy.html#cb14-7" aria-hidden="true" tabindex="-1"></a>                     POSITIVITY_RATE_MEAN,</span>
<span id="cb14-8"><a href="example-overnight-bed-occupancy.html#cb14-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>covid_train )</span>
<span id="cb14-9"><a href="example-overnight-bed-occupancy.html#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="example-overnight-bed-occupancy.html#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the census test output</span></span>
<span id="cb14-11"><a href="example-overnight-bed-occupancy.html#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>( covid_test, <span class="fu">plot</span>(date, D1_census) )</span>
<span id="cb14-12"><a href="example-overnight-bed-occupancy.html#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="example-overnight-bed-occupancy.html#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># add the lines of the predicted census count</span></span>
<span id="cb14-14"><a href="example-overnight-bed-occupancy.html#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( covid_test<span class="sc">$</span>date, <span class="fu">predict</span>( census_model, covid_test )<span class="sc">^</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="04_census-example_files/figure-html/census-plot-validation-results-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-splitting-systems.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="example-covid-19-admissions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ucdavisdatalab/workshop_model_validation/edit/master/04_census-example.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/ucdavisdatalab/workshop_model_validation/blob/master/04_census-example.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
